// --------------------------------------------------------------------------
//
// --------------------------------------------------------------------------

unit
  Digest;

// --------------------------------------------------------------------------
//
// --------------------------------------------------------------------------

interface

// --------------------------------------------------------------------------
//
// --------------------------------------------------------------------------

type
  TDigest = class
    public
      class function ComputeCRC64(Buffer: Pointer; Size: Integer): Int64;
  end;

// --------------------------------------------------------------------------
//
// --------------------------------------------------------------------------

implementation

// --------------------------------------------------------------------------
//
// --------------------------------------------------------------------------

uses
  SysUtils;

// --------------------------------------------------------------------------
// Support table for the CRC64 algorithm
// --------------------------------------------------------------------------

const
  CRC64HashTable: array [0..255] of Cardinal = (
    $00000000, $01b00000, $03600000, $02d00000, $06c00000, $07700000, $05a00000, $04100000,
    $0d800000, $0c300000, $0ee00000, $0f500000, $0b400000, $0af00000, $08200000, $09900000,
    $1b000000, $1ab00000, $18600000, $19d00000, $1dc00000, $1c700000, $1ea00000, $1f100000,
    $16800000, $17300000, $15e00000, $14500000, $10400000, $11f00000, $13200000, $12900000,
    $36000000, $37b00000, $35600000, $34d00000, $30c00000, $31700000, $33a00000, $32100000,
    $3b800000, $3a300000, $38e00000, $39500000, $3d400000, $3cf00000, $3e200000, $3f900000,
    $2d000000, $2cb00000, $2e600000, $2fd00000, $2bc00000, $2a700000, $28a00000, $29100000,
    $20800000, $21300000, $23e00000, $22500000, $26400000, $27f00000, $25200000, $24900000,
    $6c000000, $6db00000, $6f600000, $6ed00000, $6ac00000, $6b700000, $69a00000, $68100000,
    $61800000, $60300000, $62e00000, $63500000, $67400000, $66f00000, $64200000, $65900000,
    $77000000, $76b00000, $74600000, $75d00000, $71c00000, $70700000, $72a00000, $73100000,
    $7a800000, $7b300000, $79e00000, $78500000, $7c400000, $7df00000, $7f200000, $7e900000,
    $5a000000, $5bb00000, $59600000, $58d00000, $5cc00000, $5d700000, $5fa00000, $5e100000,
    $57800000, $56300000, $54e00000, $55500000, $51400000, $50f00000, $52200000, $53900000,
    $41000000, $40b00000, $42600000, $43d00000, $47c00000, $46700000, $44a00000, $45100000,
    $4c800000, $4d300000, $4fe00000, $4e500000, $4a400000, $4bf00000, $49200000, $48900000,
    $d8000000, $d9b00000, $db600000, $dad00000, $dec00000, $df700000, $dda00000, $dc100000,
    $d5800000, $d4300000, $d6e00000, $d7500000, $d3400000, $d2f00000, $d0200000, $d1900000,
    $c3000000, $c2b00000, $c0600000, $c1d00000, $c5c00000, $c4700000, $c6a00000, $c7100000,
    $ce800000, $cf300000, $cde00000, $cc500000, $c8400000, $c9f00000, $cb200000, $ca900000,
    $ee000000, $efb00000, $ed600000, $ecd00000, $e8c00000, $e9700000, $eba00000, $ea100000,
    $e3800000, $e2300000, $e0e00000, $e1500000, $e5400000, $e4f00000, $e6200000, $e7900000,
    $f5000000, $f4b00000, $f6600000, $f7d00000, $f3c00000, $f2700000, $f0a00000, $f1100000,
    $f8800000, $f9300000, $fbe00000, $fa500000, $fe400000, $fff00000, $fd200000, $fc900000,
    $b4000000, $b5b00000, $b7600000, $b6d00000, $b2c00000, $b3700000, $b1a00000, $b0100000,
    $b9800000, $b8300000, $bae00000, $bb500000, $bf400000, $bef00000, $bc200000, $bd900000,
    $af000000, $aeb00000, $ac600000, $add00000, $a9c00000, $a8700000, $aaa00000, $ab100000,
    $a2800000, $a3300000, $a1e00000, $a0500000, $a4400000, $a5f00000, $a7200000, $a6900000,
    $82000000, $83b00000, $81600000, $80d00000, $84c00000, $85700000, $87a00000, $86100000,
    $8f800000, $8e300000, $8ce00000, $8d500000, $89400000, $88f00000, $8a200000, $8b900000,
    $99000000, $98b00000, $9a600000, $9bd00000, $9fc00000, $9e700000, $9ca00000, $9d100000,
    $94800000, $95300000, $97e00000, $96500000, $92400000, $93f00000, $91200000, $90900000);

// --------------------------------------------------------------------------
//
// --------------------------------------------------------------------------

class function TDigest.ComputeCRC64(Buffer: Pointer; Size: Integer): Int64;
var
  i: Integer; cl, ch, th, tl: Cardinal;
begin
  cl := 0; ch := 0; for i := 0 to (Size - 1) do begin
    th := (ch shr 8); tl := (cl shr 8) or ((ch and $ff) shl 24);
    ch := th xor CRC64HashTable[(cl xor PByteArray(Buffer)^[i]) and $ff]; cl := tl;
  end; Result := (Int64(ch) shl 32) + Int64(cl);
end;

// --------------------------------------------------------------------------
//
// --------------------------------------------------------------------------

end.